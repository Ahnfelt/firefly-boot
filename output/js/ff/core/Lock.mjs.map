{
    "version": 3,
    "sources": [
        "../../../../core/Lock.ff"
    ],
    "sourcesContent": [
        "capability Lock(\n    mutable owner: JsValue\n    mutable level: Int\n    queue: Queue[Pair[JsValue, Unit => Unit]]\n)\n\ncapability LockCondition(\n    lock: Lock\n    queue: Queue[Unit => Unit]\n)\n\nextend self: Lock {\n\n    condition(): LockCondition {\n        LockCondition(self, Queue.new())\n    }\n    \n    acquire(): Unit {\n        if(self.level == 0 || self.owner === Js.currentTask()!) {\n            self.owner = Js.currentTask()!\n            self.level += 1\n        } else {\n            Js.awaitCancellablePromise {resolve, reject, onSettle =>\n                let key = self.queue.push(Pair(Js.currentTask()!, resolve))\n                onSettle {_ => self.queue.remove(key)}\n            }\n        }\n    }\n    \n    release(): Unit {\n        if(self.owner !== Js.currentTask()!) {\n            throw(GrabException)\n        } elseIf {self.level > 1} {\n            self.level -= 1\n        } else {\n            self.owner = Js.undefined()\n            self.level = 0\n            if(!self.queue.isEmpty()) {\n                let pending = self.queue.pop().grab()\n                self.owner = pending.first\n                self.level = 1\n                pending.second(Unit)\n            }\n        }\n    }\n    \n    do[T](body: () => T): T {\n        self.acquire()\n        try {\n            body()\n        } finally {\n            self.release()\n        }\n    }\n\n}\n\nextend self: LockCondition {\n\n    sleep(): Unit {\n        if(self.lock.owner !== Js.currentTask()!) {\n            throw(GrabException)\n        }\n        Js.throwIfCancelled()\n        let level = self.lock.level\n        self.lock.level = 1\n        self.lock.release()\n        try {\n            Js.awaitCancellablePromise {resolve, reject, onSettle =>\n                let key = self.queue.push(resolve)\n                onSettle {_ => self.queue.remove(key)}\n            }\n        } finally {\n            mutable error = Js.undefined()\n            mutable acquired = False\n            while {!acquired} {\n                try {\n                    self.lock.acquire()\n                    self.lock.level = level\n                    acquired = True\n                } catchAny {e =>\n                    error = e!\n                }\n            }\n            if(!error.isUndefined()) {Js.throw(error)}\n        }\n    }\n\n    sleepUntil[T](body: () => Option[T]): T {\n        body().{\n            | Some(value) =>\n                value\n            | None =>\n                self.sleep()\n                tailcall self.sleepUntil(body)\n        }\n    }\n\n    wakeOne(): Unit {\n        self.queue.pop().each {resolve => resolve(Unit)}\n    }\n\n    wakeAll(): Unit {\n        self.queue.each {_, resolve => resolve(Unit)}\n        self.queue.clear()\n    }\n\n}\n"
    ],
    "names": [
        "Lock",
        "owner",
        "level",
        "queue",
        "LockCondition",
        "lock",
        "condition",
        "self",
        "new",
        "acquire",
        "awaitCancellablePromise",
        "resolve",
        "reject",
        "onSettle",
        "key",
        "push",
        "Pair",
        "remove",
        "release",
        "GrabException",
        "isEmpty",
        "pending",
        "grab",
        "pop",
        "first",
        "second",
        "do",
        "body",
        "sleep",
        "error",
        "acquired",
        "e",
        "isUndefined",
        "sleepUntil",
        "Some",
        "value",
        "wakeOne",
        "wakeAll",
        "each",
        "clear"
    ],
    "mappings": "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"
}